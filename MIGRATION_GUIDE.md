# ๐ ุฑุงูููุง ูุงฺฏุฑุดู ุฏุชุงุจุณ

ุงู ุฑุงูููุง ุจุฑุง ุงูุชูุงู ุฏุชุง ุงุฒ ุฑุจุงุช ูุฏู (ููุท Hiddify) ุจู ุฑุจุงุช ุฌุฏุฏ (Hiddify + Marzban) ุงุณุช.

## โ๏ธ ูุดุฏุงุฑูุง ููู

1. **ุญุชูุงู ูุจู ุงุฒ ุงุฌุฑุง ุงุฒ ุฏุชุงุจุณ ุฌุฏุฏ ุจฺฉุงูพ ุจฺฏุฑุฏ!**
2. ุงู ุงุณฺฉุฑูพุช ููุท INSERT ูโฺฉูุฏ ู ุฏุชุง ูุจู ุฑุง ูพุงฺฉ ููโฺฉูุฏ
3. ุงุจุชุฏุง ุจุง ุชุนุฏุงุฏ ฺฉู ุฑฺฉูุฑุฏ ุชุณุช ฺฉูุฏ
4. ุจุนุถ ููุฏูุง ุฏุฑ ุฏุชุงุจุณ ูุฏู ูุฌูุฏ ูุฏุงุดุชู ู ูพุดโูุฑุถ ูโฺฏุฑูุฏ

## ๐ ูพุดโูุงุฒูุง

```bash
# ูุตุจ ฺฉุชุงุจุฎุงููโูุง ููุฑุฏ ูุงุฒ
pip install pymysql
```

## ๐ง ูุฑุงุญู ูุงฺฏุฑุดู

### ูุฑุญูู 1: ุขูุงุฏูโุณุงุฒ

```bash
# ุงุทููุงู ุงุฒ ูุฌูุฏ ูุงู demo.sql ุฏุฑ ุฏุงุฑฺฉุชูุฑ ุฑุจุงุช
ls -lh demo.sql

# ุจฺฉุงูพ ุงุฒ ุฏุชุงุจุณ ุฌุฏุฏ
# ุงฺฏุฑ SQLite:
cp bot_database.db bot_database.db.backup

# ุงฺฏุฑ MySQL/PostgreSQL:
# ุงุฒ ุฏุณุชูุฑุงุช ูุฑุจูุทู ุจุฑุง ุจฺฉุงูพ ุงุณุชูุงุฏู ฺฉูุฏ
```

### ูุฑุญูู 2: ุงุฌุฑุง ูุงฺฏุฑุดู

```bash
# ุงุฌุฑุง ุงุณฺฉุฑูพุช ูุงฺฏุฑุดู
python migrate_old_database.py
```

### ูุฑุญูู 3: ุจุฑุฑุณ ูุชุงุฌ

```bash
# ุจุฑุฑุณ ูุงู ูุงฺฏ ุฎุทุงูุง (ุงฺฏุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ)
cat migration_errors.log
```

## ๐ ูฺฏุงุดุช (Mapping) ุฌุฏุงูู

### ฺฉุงุฑุจุฑุงู (Users)

| ุฏุชุงุจุณ ูุฏู | ุฏุชุงุจุณ ุฌุฏุฏ | ุชูุถุญุงุช |
|--------------|-------------|---------|
| `users.account_id` | `users.user_id` | ุดูุงุณู ฺฉุงุฑุจุฑ |
| `users.role` (admin/agent/user) | `users.role` (admin/marketer/customer) | ููุด ฺฉุงุฑุจุฑ - agent โ marketer |
| `account_ballances.ballance` | `users.wallet_balance` | ููุฌูุฏ ฺฉู ูพูู |
| `referral_wallets.amount` | `users.commission_balance` | ููุฌูุฏ ฺฉูุณูู |
| `bot_users.*` | - | ุงุทูุงุนุงุช ุชูฺฏุฑุงู (ุฏุฑ ุฌุฏูู ุฌุฏุงฺฏุงูู ูุณุช) |

### ูพููโูุง (Panels)

| ุฏุชุงุจุณ ูุฏู | ุฏุชุงุจุณ ุฌุฏุฏ | ุชูุถุญุงุช |
|--------------|-------------|---------|
| `pannels.location` | `panels.name` | ูุงู ูพูู |
| `pannels.type` (ููุดู hiddify) | `panels.panel_type` | ููุน ูพูู |
| `pannels.url_port` | `panels.api_base_url` | ุขุฏุฑุณ ูพูู |
| `pannels.username` | `panels.username` | ูุงู ฺฉุงุฑุจุฑ |
| `pannels.password` | `panels.password` | ุฑูุฒ ุนุจูุฑ |

### ูพููโูุง (Plans)

| ุฏุชุงุจุณ ูุฏู | ุฏุชุงุจุณ ุฌุฏุฏ | ุชูุถุญุงุช |
|--------------|-------------|---------|
| `product_categories.category_name` | `plans.name` | ูุงู ูพูู |
| `product_categories.expire_day` | `plans.duration_days` | ูุฏุช ุฒูุงู |
| `product_categories.volume` | `plans.traffic_gb` | ุญุฌู ุชุฑุงูฺฉ |
| `product_categories.price` | `plans.price` | ููุช |
| - | `plans.device_limit` | ูุญุฏูุฏุช ุฏุณุชฺฏุงู (ูพุดโูุฑุถ: 1) |

### ุณุฑูุณโูุง (Services)

| ุฏุชุงุจุณ ูุฏู | ุฏุชุงุจุณ ุฌุฏุฏ | ุชูุถุญุงุช |
|--------------|-------------|---------|
| `products.account_id` | `services.user_id` | ุดูุงุณู ฺฉุงุฑุจุฑ |
| `products.product_categories_id` | `services.plan_id` | ุดูุงุณู ูพูู |
| UUID ุงุฒ `subscription_link` | `services.username_in_panel` | ูุงู ฺฉุงุฑุจุฑ ุฏุฑ ูพูู |
| `products.remark` | `services.note` | ุงุฏุฏุงุดุช |
| `products.created_at` | `services.start_date` | ุชุงุฑุฎ ุดุฑูุน |
| `created_at + expire_day` | `services.expire_date` | ุชุงุฑุฎ ุงููุถุง (ูุญุงุณุจู ูโุดูุฏ) |
| `products.isActive` | `services.is_active` | ูุถุนุช ูุนุงู |

### ุชุฑุงฺฉูุดโูุง (Transactions)

| ุฏุชุงุจุณ ูุฏู | ุฏุชุงุจุณ ุฌุฏุฏ | ุชูุถุญุงุช |
|--------------|-------------|---------|
| `transactions.account_id` | `transactions.user_id` | ุดูุงุณู ฺฉุงุฑุจุฑ |
| `transactions.amount` | `transactions.amount` | ูุจูุบ |
| `transactions.confirmed` | `transactions.status` | confirmed==1 โ COMPLETED |
| `transactions.recipe_number` | `transactions.tracking_code` | ฺฉุฏ ูพฺฏุฑ |
| `transactions.payment_type_id` | `transactions.type` | ููุน ุชุฑุงฺฉูุด |

## ๐ ููุงุฑุฏ ูุงุฒููุฏ ุจุฑุฑุณ ุฏุณุช

### 1. Referrer_id
ุฏุฑ ุฏุชุงุจุณ ูุฏูุ ุงุทูุงุนุงุช referral ุฏุฑ ุฌุฏูู `referral_logs` ุงุณุชุ ูู ุฏุฑ ุฏุชุงุจุณ ุฌุฏุฏ ุจุงุฏ `referrer_id` ุฏุฑ ุฌุฏูู `users` ุชูุธู ุดูุฏ. ุงู ฺฉุงุฑ ูุงุฒ ุจู ฺฉ ฺฉูุฆุฑ ุงุถุงู ุฏุงุฑุฏ ฺฉู ุฏุฑ ูุณุฎู ูุนู ุงุณฺฉุฑูพุช ูพุงุฏูโุณุงุฒ ูุดุฏู.

**ุฑุงู ุญู:**
```sql
-- ุจุนุฏ ุงุฒ ูุงฺฏุฑุดูุ ุงู ฺฉูุฆุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ
UPDATE users
SET referrer_id = (
    SELECT referral_user_id 
    FROM referral_logs 
    WHERE referral_to_id = users.user_id 
    LIMIT 1
)
WHERE user_id IN (SELECT DISTINCT referral_to_id FROM referral_logs);
```

### 2. Plan_id ุฏุฑ Transactions
ุฏุฑ ุฏุชุงุจุณ ูุฏูุ ุชุฑุงฺฉูุดโูุง `plan_id` ูุฏุงุฑูุฏ. ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุงู ุงุทูุงุนุงุช ุฑุง ุงุถุงูู ฺฉูุฏุ ุจุงุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ุชุงุฑุฎ ุชุฑุงฺฉูุด ู ุฎุฑุฏูุง ฺฉุงุฑุจุฑุ ูพูู ูุฑุจูุทู ุฑุง ุชุดุฎุต ุฏูุฏ.

### 3. Commission Records
ุงฺฏุฑ ูโุฎูุงูุฏ ุณูุงุจู ฺฉูุณูู ุฑุง ูู ููุชูู ฺฉูุฏุ ุจุงุฏ ุฌุฏูู `referral_logs` ุฑุง ุจู `commissions` ููพ ฺฉูุฏ. ุงู ุจุฎุด ุฏุฑ ูุณุฎู ูุนู ุงุณฺฉุฑูพุช ูพุงุฏูโุณุงุฒ ูุดุฏู.

## ๐ ุฑูุน ูุดฺฉูุงุช ุฑุงุฌ

### ุฎุทุง: "User not found"
- **ุนูุช**: ฺฉุงุฑุจุฑ ุฏุฑ ุฌุฏูู users ูุฏู ูุฌูุฏ ูุฏุงุฑุฏ
- **ุฑุงู ุญู**: ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง ุชูุงู ฺฉุงุฑุจุฑุงู ููุฌูุฏ ุฏุฑ `bot_users` ุฏุฑ `users` ูู ูุณุชูุฏ

### ุฎุทุง: "Plan not found"
- **ุนูุช**: ุฏุณุชูโุจูุฏ ูุญุตูู ุบุฑูุนุงู ุงุณุช ุง ุญุฐู ุดุฏู
- **ุฑุงู ุญู**: ููุท `product_categories` ุจุง `is_active=1` ูุงฺฏุฑุช ูโุดููุฏ

### ุฎุทุง: "Invalid UUID"
- **ุนูุช**: ููฺฉ subscription ูุฑูุช ุงุณุชุงูุฏุงุฑุฏ UUID ูุฏุงุฑุฏ
- **ุฑุงู ุญู**: ุงุณฺฉุฑูพุช ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉ username ุฌุงฺฏุฒู ูโุณุงุฒุฏ

## ๐ ุขูุงุฑ ูุงฺฏุฑุดู

ุฏุฑ ูพุงุงู ูุงฺฏุฑุดูุ ฺฉ ุฎูุงุตู ููุงุด ุฏุงุฏู ูโุดูุฏ:

```
๐ ุฎูุงุตู ูุงฺฏุฑุดู
==========================================================
  users: โ 445 | โ 2
  panels: โ 6 | โ 0
  plans: โ 18 | โ 0
  services: โ 1138 | โ 3
  transactions: โ 423 | โ 2

  ฺฉู ูููู: 2030
  ฺฉู ูุงูููู: 7
```

## ๐ ูฺฉุงุช ุงููุช

1. ูุงู `demo.sql` ุญุงู ุงุทูุงุนุงุช ุญุณุงุณ ุงุณุช - ุจุนุฏ ุงุฒ ูุงฺฏุฑุดู ุขู ุฑุง ูพุงฺฉ ฺฉูุฏ
2. ูุงู `migration_errors.log` ููฺฉู ุงุณุช ุญุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑุงู ุจุงุดุฏ
3. ุจฺฉุงูพโูุง ุฎูุฏ ุฑุง ุฏุฑ ูฺฉุงู ุงูู ูฺฏูุฏุงุฑ ฺฉูุฏ

## ๐ ูพุดุชุจุงู

ุงฺฏุฑ ุจุง ูุดฺฉู ููุงุฌู ุดุฏุฏ:
1. ุงุจุชุฏุง ูุงู `migration_errors.log` ุฑุง ุจุฑุฑุณ ฺฉูุฏ
2. ุฎุทุงูุง ุฑุงุฌ ุฑุง ุฏุฑ ุจุฎุด "ุฑูุน ูุดฺฉูุงุช" ฺฺฉ ฺฉูุฏ
3. ุงุฒ ุฏุณุชูุฑ ุฒุฑ ุจุฑุง ุฏุฑุงูุช ุงุทูุงุนุงุช ุจุดุชุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
python migrate_old_database.py --verbose
```

## โ ฺฺฉโูุณุช ุจุนุฏ ุงุฒ ูุงฺฏุฑุดู

- [ ] ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ุจุง ุฏุชุงุจุณ ูุฏู ูุทุงุจูุช ุฏุงุฑุฏ
- [ ] ููุฌูุฏ ฺฉู ูพููโูุง ุฏุฑุณุช ููุชูู ุดุฏู
- [ ] ูพููโูุง ูุงุจู ุฏุณุชุฑุณ ูุณุชูุฏ
- [ ] ูพููโูุง ุจุง ููุช ู ูุฏุช ุฒูุงู ุฏุฑุณุช ุณุงุฎุชู ุดุฏูโุงูุฏ
- [ ] ุณุฑูุณโูุง ูุนุงู ุฏุฑุณุช ฺฉุงุฑ ูโฺฉููุฏ
- [ ] ุชุฑุงฺฉูุดโูุง ุจุง ูุถุนุช ุตุญุญ ุซุจุช ุดุฏูโุงูุฏ
- [ ] ุจฺฉุงูพ ุฏุชุงุจุณ ูุฏู ุฏุฑ ุฌุง ุงูู ุฐุฎุฑู ุดุฏู
- [ ] ูุงู `demo.sql` ูพุงฺฉ ุดุฏู (ุจุนุฏ ุงุฒ ุงุทููุงู ุงุฒ ููููุช)
- [ ] Referrer_id ูุง ุจูโุฑูุฒุฑุณุงู ุดุฏูโุงูุฏ (ฺฉูุฆุฑ SQL)

---

**ูุณุฎู:** 1.0.0  
**ุชุงุฑุฎ ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู:** 2025-10-19  
**ุณุงุฒฺฏุงุฑ ุจุง:** MeowVPN Bot v2.0+

