# 💳 راهنمای سیستم مدیریت چند کارت بانکی

## 🌟 معرفی

این یک سیستم پیشرفته و هوشمند برای مدیریت چند شماره کارت در پرداخت کارت به کارت است.

### ویژگی‌های کلیدی:
- 💳 **چند کارت بانکی** - امکان تعریف کارت‌های متعدد
- 📊 **سقف روزانه** - تعیین حداکثر مبلغ دریافتی برای هر کارت
- 🔢 **اولویت‌بندی** - ترتیب استفاده از کارت‌ها
- 🔄 **تعویض خودکار** - وقتی سقف یک کارت پر شد، به کارت بعدی می‌رود
- 📈 **آمار لحظه‌ای** - نمایش دریافتی امروز و باقیمانده
- 🔔 **Reset خودکار** - در نیمه شب، مبالغ روزانه صفر می‌شوند

---

## 🎯 نحوه کار

### الگوریتم انتخاب کارت:

```
هنگام درخواست پرداخت کارت به کارت:
1. سیستم لیست کارت‌ها را بر اساس اولویت مرتب می‌کند (کوچکتر = بالاتر)
2. کارت اول (با بالاترین اولویت) را بررسی می‌کند
3. اگر ظرفیت دارد (current_amount + amount <= daily_limit):
   ✅ این کارت را نمایش می‌دهد
4. اگر ظرفیت ندارد:
   ⏭️ به کارت بعدی می‌رود
5. تا زمانی که کارت با ظرفیت کافی پیدا شود
6. اگر هیچ کارتی ظرفیت نداشت:
   ⚠️ پیام خطا نمایش می‌دهد
```

### مثال کاربردی:

```
کارت 1: اولویت 0، سقف 50 میلیون، دریافتی: 45 میلیون → باقیمانده: 5 میلیون
کارت 2: اولویت 1، سقف 30 میلیون، دریافتی: 0 → باقیمانده: 30 میلیون  
کارت 3: اولویت 2، سقف نامحدود، دریافتی: 20 میلیون → باقیمانده: نامحدود

کاربر می‌خواهد 10 میلیون تومان واریز کند:
→ کارت 1 ظرفیت ندارد (فقط 5 میلیون باقیمانده)
→ کارت 2 انتخاب می‌شود ✅ (30 میلیون ظرفیت دارد)
→ شماره کارت 2 به کاربر نمایش داده می‌شود
```

---

## 📖 راهنمای استفاده

### برای ادمین:

#### 1. ورود به بخش مدیریت کارت‌ها:
```
/admin
  → ⚙️ تنظیمات ربات
    → 💳 مدیریت کارت‌ها
```

#### 2. افزودن کارت جدید:
```
➕ افزودن کارت جدید
```

**اطلاعات مورد نیاز:**
1. **شماره کارت** (16 رقم)
   - مثال: `6037997712345678`
   
2. **نام صاحب حساب**
   - مثال: `علی محمدی`
   
3. **سقف روزانه** (تومان)
   - مثال: `50000000` (پنجاه میلیون)
   - یا `0` برای نامحدود
   
4. **اولویت**
   - عدد کوچکتر = اولویت بالاتر
   - مثال: `0` برای اولین کارت، `1` برای دومین
   
5. **یادداشت** (اختیاری)
   - مثال: `کارت اصلی - ملی`

#### 3. مدیریت کارت موجود:

از لیست کارت‌ها، روی کارت مورد نظر کلیک کنید:

**گزینه‌ها:**
- 📊 **ویرایش سقف روزانه** - تغییر حداکثر مبلغ
- 🔢 **تغییر اولویت** - تغییر ترتیب استفاده
- 📝 **ویرایش یادداشت** - اضافه/تغییر توضیحات
- ✅/❌ **فعال/غیرفعال کردن** - موقتاً از کار انداختن بدون حذف
- 🗑 **حذف کارت** - حذف کامل از سیستم

#### 4. مشاهده آمار:

در لیست کارت‌ها می‌بینید:
- شماره کارت (4 رقم اول و آخر)
- نام صاحب حساب
- سقف روزانه
- **دریافتی امروز** 💰
- **باقیمانده** ✅
- وضعیت (فعال/غیرفعال)

---

## 🔄 Reset خودکار

هر شب ساعت **00:01** (نیمه شب):
- مبلغ `current_amount` تمام کارت‌ها به **صفر** می‌شود
- `last_reset_date` به‌روزرسانی می‌شود
- سقف روزانه از نو شروع می‌شود

---

## 💡 نکات مهم

### ✅ انجام دهید:

1. **اولویت‌بندی مناسب:**
   - کارت اصلی: اولویت 0
   - کارت پشتیبان: اولویت 1، 2، ...

2. **سقف واقع‌بینانه:**
   - محدودیت‌های بانکی را در نظر بگیرید
   - حداقل 20% کمتر از حد مجاز بانک

3. **حداقل یک کارت نامحدود:**
   - برای اطمینان از عدم قطع سرویس
   - معمولاً با کمترین اولویت

4. **یادداشت‌های واضح:**
   - نام بانک
   - نوع کارت (ملی، تجاری، ...)

### ⚠️ اجتناب کنید:

1. **فعال نگذاشتن همه کارت‌ها:**
   - حداقل یک کارت همیشه فعال باشد

2. **اولویت یکسان:**
   - ممکن است نتیجه غیرقابل پیش‌بینی داشته باشد

3. **سقف خیلی کم:**
   - باعث تعویض مکرر کارت می‌شود

---

## 📊 مثال‌های کاربردی

### پیکربندی پیشنهادی برای فروش کم:

```
کارت 1:
  - شماره: 6037-****-****-1234
  - صاحب: علی محمدی
  - سقف: 20,000,000 تومان
  - اولویت: 0
  - یادداشت: "کارت اصلی - ملی"

کارت 2:
  - شماره: 6219-****-****-5678
  - صاحب: علی محمدی
  - سقف: نامحدود
  - اولویت: 1
  - یادداشت: "کارت پشتیبان - سامان"
```

**نتیجه:**
- تا 20 میلیون از کارت 1 استفاده می‌شود
- بعد از آن، کارت 2 (نامحدود)

### پیکربندی برای فروش بالا:

```
کارت 1: سقف 50M، اولویت 0، "کارت اصلی"
کارت 2: سقف 50M، اولویت 1، "کارت دوم"
کارت 3: سقف 30M، اولویت 2، "کارت سوم"
کارت 4: نامحدود، اولویت 3، "کارت احتیاطی"
```

**نتیجه:**
- توزیع هوشمند بار بین کارت‌ها
- جلوگیری از مسدود شدن

---

## 🔧 مدیریت روزانه

### چک‌لیست روزانه ادمین:

```
صبح (9-10):
  □ ورود به بخش مدیریت کارت‌ها
  □ بررسی دریافتی امروز هر کارت
  □ اطمینان از ظرفیت کافی

عصر (اگر فروش بالاست):
  □ بررسی مجدد
  □ در صورت نیاز، افزایش سقف

شب:
  □ بررسی آمار کل روز
  □ برنامه‌ریزی برای فردا
```

### نظارت بر آمار:

از لیست کارت‌ها می‌توانید ببینید:
- چه مبلغی امروز دریافت شده
- چقدر ظرفیت باقی مانده
- کدام کارت بیشتر استفاده شده

---

## 🚨 خطاها و راه‌حل‌ها

### خطا: "هیچ کارت فعالی با ظرفیت کافی موجود نیست"

**علت:**
- تمام کارت‌ها به سقف رسیده‌اند
- یا همه غیرفعال هستند

**راه‌حل:**
1. سقف یکی از کارت‌ها را افزایش دهید
2. یا یک کارت جدید اضافه کنید
3. یا یک کارت را نامحدود کنید

### خطا: "شماره کارت نامعتبر"

**علت:**
- شماره کارت کمتر یا بیشتر از 16 رقم است

**راه‌حل:**
- دقیقاً 16 رقم وارد کنید
- بدون فاصله یا خط تیره

---

## 🎯 مزایا

### برای ادمین:
✅ مدیریت آسان چند کارت  
✅ جلوگیری از مسدود شدن  
✅ توزیع هوشمند بار  
✅ نظارت دقیق بر دریافتی‌ها  
✅ انعطاف‌پذیری بالا  

### برای کاربران:
✅ همیشه کارت فعال موجود است  
✅ پرداخت بدون وقفه  
✅ تجربه کاربری یکپارچه  

### برای کسب‌وکار:
✅ کاهش ریسک مسدودسازی  
✅ افزایش حجم تراکنش  
✅ مدیریت بهتر نقدینگی  
✅ آمار دقیق دریافتی‌ها  

---

## 🔐 امنیت

### محافظت شده در برابر:
- ✅ استفاده بیش از حد (سقف روزانه)
- ✅ مسدود شدن کارت (چند کارت)
- ✅ خطای انسانی (خودکارسازی)
- ✅ از دست دادن اطلاعات (لاگ کامل)

### پیشنهادات امنیتی:
- 🔒 از کارت‌های مختلف استفاده کنید
- 🔒 سقف‌ها را محافظه‌کارانه تعیین کنید
- 🔒 روزانه آمار را بررسی کنید
- 🔒 کارت‌های غیرضروری را غیرفعال کنید

---

## 📝 Migration

برای فعال‌سازی این قابلیت:

```bash
alembic upgrade head
```

این migration جدول `card_accounts` را می‌سازد با فیلدهای:
- id
- card_number (unique)
- card_holder
- daily_limit
- current_amount
- priority
- is_active
- created_at
- last_reset_date
- note

---

## 🧪 تست

### سناریو تست 1: افزودن کارت

```
1. ورود به پنل ادمین (/admin)
2. تنظیمات ربات → مدیریت کارت‌ها
3. افزودن کارت جدید
4. وارد کردن:
   - شماره: 6037997712345678
   - نام: تست تستی
   - سقف: 10000000
   - اولویت: 0
5. تایید
✅ باید کارت در لیست ظاهر شود
```

### سناریو تست 2: پرداخت کارت به کارت

```
1. با یک اکانت عادی، خرید سرویس کنید
2. پرداخت کارت به کارت را انتخاب کنید
3. باید شماره کارت با بالاترین اولویت و ظرفیت کافی نمایش داده شود
✅ شماره کارت صحیح نمایش داده می‌شود
```

### سناریو تست 3: تعویض خودکار

```
1. کارت 1 را با سقف 1,000,000 تومان تعریف کنید
2. کارت 2 را با سقف نامحدود و اولویت 1 تعریف کنید
3. چند بار پرداخت تا سقف کارت 1 پر شود
4. پرداخت بعدی باید کارت 2 را نشان دهد
✅ تعویض خودکار انجام می‌شود
```

### سناریو تست 4: Reset روزانه

```
1. تنظیم زمان job به چند دقیقه بعد برای تست
2. صبر کنید تا job اجرا شود
3. current_amount همه کارت‌ها باید صفر شود
✅ Reset انجام می‌شود
```

---

## 🛠️ API

### Query Functions:

```python
# ایجاد کارت
card = card_queries.create_card_account(db, card_number, card_holder, daily_limit, priority)

# دریافت کارت مناسب
card = card_queries.get_available_card_for_amount(db, amount)

# اضافه کردن مبلغ
card_queries.add_amount_to_card(db, card_id, amount)

# Reset روزانه
count = card_queries.reset_daily_amounts(db)

# آمار
stats = card_queries.get_card_statistics(db, card_id)
```

---

## 🎨 رابط کاربری

### لیست کارت‌ها:

```
💳 لیست کارت‌های بانکی:

#0 ✅
💳 کارت: 6037-****-****-1234
👤 نام: علی محمدی
📊 سقف روزانه: 50,000,000 تومان
💰 دریافتی امروز: 30,000,000 تومان
✅ باقیمانده: 20,000,000 تومان
━━━━━━━━━━

#1 ✅
💳 کارت: 6219-****-****-5678
👤 نام: رضا احمدی
📊 سقف روزانه: نامحدود
💰 دریافتی امروز: 15,000,000 تومان
✅ باقیمانده: نامحدود
━━━━━━━━━━

[➕ افزودن کارت جدید]
```

### جزئیات کارت:

```
💳 جزئیات کارت بانکی

💳 شماره کارت: 6037-****-****-1234
👤 صاحب حساب: علی محمدی

📊 وضعیت مالی:
- سقف روزانه: 50,000,000 تومان
- دریافتی امروز: 30,000,000 تومان
- باقیمانده: 20,000,000 تومان
- درصد استفاده: 60.0%

⚙️ تنظیمات:
- اولویت: 0
- وضعیت: فعال
- یادداشت: کارت اصلی - ملی

[📊 ویرایش سقف] [🔢 تغییر اولویت]
[📝 ویرایش یادداشت]
[❌ غیرفعال کردن] [🗑 حذف کارت]
[ بازگشت]
```

---

## 📈 بهترین شیوه‌ها (Best Practices)

### 1. ساختار پیشنهادی:

```
کارت اصلی:
  اولویت: 0
  سقف: 40-50 میلیون
  نوع: کارت شخصی

کارت دوم:
  اولویت: 1
  سقف: 30-40 میلیون
  نوع: کارت دیگر

کارت احتیاطی:
  اولویت: 2
  سقف: نامحدود
  نوع: کارت تجاری یا حساب بزرگ
```

### 2. نظارت و بهینه‌سازی:

- روزانه آمار را بررسی کنید
- سقف‌ها را بر اساس نیاز تنظیم کنید
- کارت‌های کم‌استفاده را حذف کنید
- اولویت‌ها را بر اساس عملکرد تغییر دهید

### 3. استراتژی پشتیبان:

- همیشه حداقل 2 کارت فعال داشته باشید
- یک کارت با سقف نامحدود برای شرایط اضطراری
- کارت‌های متنوع از بانک‌های مختلف

---

## 🔮 قابلیت‌های آینده

این سیستم آماده است برای:
- [ ] نوتیفیکیشن هنگام نزدیک شدن به سقف
- [ ] گزارش روزانه/هفتگی عملکرد هر کارت
- [ ] تنظیم سقف به صورت ساعتی
- [ ] تعیین بازه زمانی برای هر کارت
- [ ] Auto-priority (تنظیم خودکار اولویت بر اساس عملکرد)

---

## 💬 سوالات متداول

**Q: چه تعداد کارت می‌توانم اضافه کنم؟**
A: نامحدود! اما 3-5 کارت معمولاً کافی است.

**Q: چگونه اولویت را تغییر دهم؟**
A: از منوی مدیریت کارت → تغییر اولویت

**Q: سقف روزانه دقیقاً چیست؟**
A: حداکثر مبلغی که در یک روز (از نیمه شب تا نیمه شب) به آن کارت می‌تواند واریز شود.

**Q: اگر کارت مسدود شد چه کنم؟**
A: آن کارت را غیرفعال کنید تا از کارت بعدی استفاده شود.

**Q: آیا می‌توان سقف را در طول روز تغییر داد؟**
A: بله! هر زمان که بخواهید.

**Q: Reset ساعت چند است؟**
A: 00:01 (نیمه شب) - قابل تنظیم در `main.py`

---

<div align="center">

**با این سیستم، دیگر نگران مسدود شدن کارت نیستید!** 💪

نسخه: 2.5.0+ | تاریخ: 2025-10-16

</div>

