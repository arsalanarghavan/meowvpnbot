# 🔄 راهنمای سریع مایگریشن

این راهنما برای انتقال سریع دیتا از ربات قدیمی (Hiddify فقط) به ربات جدید (Hiddify + Marzban).

## 🚀 شروع سریع (3 مرحله)

### 1️⃣ بکاپ (ضروری!)

```bash
# اجرای اسکریپت بکاپ
./backup_database.sh

# یا به صورت دستی (SQLite):
cp bot_database.db bot_database.db.backup
```

### 2️⃣ تست مایگریشن

```bash
# تست بدون تغییر دیتابیس
python test_migration.py
```

### 3️⃣ مایگریشن کامل

```bash
# اجرای مایگریشن
python migrate_old_database.py
```

---

## 📁 فایل‌های موجود

| فایل | توضیحات |
|------|---------|
| `migrate_old_database.py` | اسکریپت اصلی مایگریشن |
| `test_migration.py` | اسکریپت تست (بدون تغییر دیتا) |
| `backup_database.sh` | اسکریپت بکاپ خودکار |
| `MIGRATION_GUIDE.md` | راهنمای کامل و جزئیات فنی |
| `demo.sql` | دیتابیس قدیمی (باید در همین دایرکتوری باشد) |

---

## ✅ چک‌لیست قبل از شروع

- [ ] فایل `demo.sql` در دایرکتوری ربات قرار دارد
- [ ] از دیتابیس جدید بکاپ گرفته شده
- [ ] تست مایگریشن اجرا شده و موفق بوده
- [ ] به دستورالعمل‌ها دقت کرده‌اید

---

## ⚠️ نکات مهم

### 1. این اسکریپت چه کاری انجام می‌دهد؟

✅ **انجام می‌دهد:**
- انتقال کاربران + موجودی کیف پول
- انتقال پنل‌های Hiddify
- انتقال پلن‌ها (دسته‌بندی محصولات)
- انتقال سرویس‌ها (محصولات خریداری شده)
- انتقال تراکنش‌ها

❌ **انجام نمی‌دهد:**
- پاک کردن یا تغییر دیتابیس قدیمی
- تغییر دیتای موجود در دیتابیس جدید
- انتقال خودکار `referrer_id` (نیاز به کوئری دستی)
- انتقال کمیسیون‌ها (نیاز به توسعه اضافی)

### 2. موارد نیازمند بررسی دستی

بعد از مایگریشن، این موارد را چک کنید:

```sql
-- 1. بررسی تعداد کاربران
SELECT COUNT(*) FROM users;

-- 2. بررسی مجموع موجودی کیف پول‌ها
SELECT SUM(wallet_balance) FROM users;

-- 3. بررسی پنل‌های فعال
SELECT * FROM panels WHERE is_active = 1;

-- 4. بررسی سرویس‌های فعال
SELECT COUNT(*) FROM services WHERE is_active = 1;
```

### 3. Referrer_id چطور تنظیم بشه؟

بعد از مایگریشن، این کوئری رو اجرا کنید:

```sql
-- به‌روزرسانی referrer_id از referral_logs
UPDATE users
SET referrer_id = (
    SELECT referral_user_id 
    FROM referral_logs 
    WHERE referral_to_id = users.user_id 
    LIMIT 1
)
WHERE user_id IN (
    SELECT DISTINCT referral_to_id 
    FROM referral_logs
);
```

---

## 🐛 مشکلات رایج

### خطا: `FileNotFoundError: demo.sql`
**راه حل:** فایل `demo.sql` را در همان دایرکتوری که اسکریپت هست قرار دهید

### خطا: `User not found`
**راه حل:** این نرمال است - برخی سرویس‌ها ممکن است کاربر مرتبط نداشته باشند

### خطا: `Plan not found`
**راه حل:** فقط پلن‌های فعال (`is_active=1`) مایگریت می‌شوند

### خطا: `Invalid UUID`
**راه حل:** اسکریپت به صورت خودکار یک username جایگزین می‌سازد

---

## 📊 آمار نمونه

```
📊 خلاصه مایگریشن
==========================================================
  users: ✅ 445 | ❌ 2
  panels: ✅ 6 | ❌ 0
  plans: ✅ 18 | ❌ 0
  services: ✅ 1138 | ❌ 3
  transactions: ✅ 423 | ❌ 2

  کل موفق: 2030
  کل ناموفق: 7
```

اگر تعداد خطاها کم باشد (کمتر از 1%)، عادی است.

---

## 📞 پشتیبانی

### فایل لاگ خطاها
```bash
cat migration_errors.log
```

### دستورات دیباگ
```bash
# مشاهده جزئیات بیشتر
python migrate_old_database.py --verbose

# تست فقط 10 رکورد
python migrate_old_database.py --test --limit 10
```

---

## 🔐 امنیت

- ❗ فایل `demo.sql` حاوی اطلاعات حساس است
- ❗ بعد از مایگریشن موفق، آن را پاک کنید
- ❗ بکاپ‌ها را در مکان امن ذخیره کنید

```bash
# پاک کردن demo.sql بعد از اطمینان
rm demo.sql

# پاک کردن فایل لاگ
rm migration_errors.log
```

---

## 📚 مستندات کامل

برای جزئیات بیشتر، فایل `MIGRATION_GUIDE.md` را مطالعه کنید.

---

**آخرین به‌روزرسانی:** 2025-10-19  
**نسخه:** 1.0.0  
**سازگار با:** MeowVPN Bot v2.0+

---

## 💡 نکته‌های پایانی

1. ⏱️ **زمان مایگریشن**: بسته به تعداد رکوردها، ممکن است 5-30 دقیقه طول بکشد
2. 🔄 **قابل تکرار**: می‌توانید مایگریشن را چند بار اجرا کنید (رکوردهای تکراری ایجاد نمی‌شود)
3. 📈 **مقیاس‌پذیری**: برای دیتابیس‌های بزرگ (>10000 رکورد)، ممکن است نیاز به تنظیمات اضافی باشد
4. 🧪 **تست کامل**: بعد از مایگریشن، ربات را تست کنید تا اطمینان حاصل شود همه چیز کار می‌کند

---

**موفق باشید! 🚀**

