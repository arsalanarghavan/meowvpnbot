# راهنمای یکپارچه‌سازی Hiddify با ربات

## نمای کلی

این ربات اکنون از دو نوع پنل VPN پشتیبانی می‌کند:
- **Marzban** 🔷
- **Hiddify** 🔶

شما می‌توانید هر دو نوع پنل را به طور همزمان در ربات خود اضافه کنید و ربات به صورت خودکار با هر کدام بر اساس نوع آن ارتباط برقرار می‌کند.

---

## تغییرات انجام شده

### 1. مدل پایگاه داده
- فیلد `panel_type` به جدول `panels` اضافه شد
- مقادیر ممکن: `MARZBAN` یا `HIDDIFY`
- مقدار پیش‌فرض برای پنل‌های موجود: `MARZBAN`

### 2. سرویس‌های جدید
- **`HiddifyAPI`**: کلاس API برای ارتباط با پنل Hiddify
- **`PanelAPIFactory`**: کارخانه برای انتخاب خودکار API مناسب

### 3. رابط کاربری مدیریت پنل‌ها
- انتخاب نوع پنل هنگام افزودن پنل جدید
- نمایش آیکون مشخص برای هر نوع پنل در لیست
  - 🔷 برای Marzban
  - 🔶 برای Hiddify

---

## مایگریشن دیتابیس

قبل از استفاده، باید مایگریشن دیتابیس را اجرا کنید:

```bash
# اجرای مایگریشن
alembic upgrade head
```

این مایگریشن به طور خودکار:
- فیلد `panel_type` را به جدول `panels` اضافه می‌کند
- مقدار پیش‌فرض `MARZBAN` را برای پنل‌های موجود تنظیم می‌کند

---

## استفاده از ربات

### افزودن پنل Hiddify

1. به عنوان مدیر وارد ربات شوید
2. به منوی **تنظیمات > مدیریت پنل‌ها** بروید
3. روی **➕ افزودن پنل جدید** کلیک کنید
4. نوع پنل را انتخاب کنید: **🔶 Hiddify**
5. اطلاعات پنل را وارد کنید:
   - نام پنل (برای شناسایی)
   - آدرس URL پنل (مثال: `https://panel.example.com`)
   - نام کاربری ادمین
   - رمز عبور ادمین
6. اطلاعات را تایید کنید

### افزودن پنل Marzban

مراحل مشابه Hiddify است، با این تفاوت که در مرحله 4 باید **🔷 Marzban** را انتخاب کنید.

---

## قابلیت‌های پشتیبانی شده

تمام قابلیت‌های ربات با هر دو نوع پنل کار می‌کنند:

✅ ایجاد کاربر جدید
✅ دریافت اطلاعات کاربر
✅ تمدید سرویس
✅ غیرفعال‌سازی کاربر
✅ ریست UUID
✅ دریافت آمار سیستم
✅ لیست کاربران
✅ ترکیب لینک‌های اشتراک از چند پنل
✅ تمدید خودکار
✅ نوتیفیکیشن‌های اتومات
✅ اکانت تست

---

## نکات مهم

### 1. سازگاری API

کلاس `HiddifyAPI` به گونه‌ای طراحی شده که خروجی‌های آن با `MarzbanAPI` سازگار است. این یعنی:
- تمام کدهای موجود بدون تغییر کار می‌کنند
- می‌توانید پنل‌های Marzban و Hiddify را همزمان استفاده کنید
- لینک‌های اشتراک از هر دو نوع پنل به صورت خودکار ترکیب می‌شوند

### 2. مدیریت خطا

- اگر یک پنل در دسترس نباشد، ربات به پنل‌های دیگر متصل می‌شود
- اگر هیچ پنلی در دسترس نباشد، کاربر پیغام خطای مناسب دریافت می‌کند

### 3. پنل‌های فعال/غیرفعال

- فقط پنل‌هایی که وضعیت `is_active = True` دارند استفاده می‌شوند
- می‌توانید پنل‌ها را موقتاً غیرفعال کنید بدون اینکه حذفشان کنید

---

## API Endpoints مورد استفاده

### Hiddify API

```
POST   /api/v2/admin/login              # احراز هویت
POST   /api/v2/admin/user/              # ایجاد کاربر
GET    /api/v2/admin/user/{username}/   # دریافت اطلاعات کاربر
PUT    /api/v2/admin/user/{username}/   # بروزرسانی کاربر
POST   /api/v2/admin/user/{username}/reset/  # ریست UUID
GET    /api/v2/admin/system/            # آمار سیستم
GET    /api/v2/admin/user/              # لیست کاربران
```

### Marzban API

```
POST   /api/admin/token                 # احراز هویت
POST   /api/user                        # ایجاد کاربر
GET    /api/user/{username}             # دریافت اطلاعات کاربر
PUT    /api/user/{username}             # بروزرسانی کاربر
POST   /api/user/{username}/reset       # ریست UUID
GET    /api/system                      # آمار سیستم
GET    /api/users                       # لیست کاربران
```

---

## عیب‌یابی

### خطای احراز هویت

اگر پیغام خطای احراز هویت دریافت کردید:
1. آدرس URL پنل را بررسی کنید (نباید `/` در انتها داشته باشد)
2. نام کاربری و رمز عبور را مجدداً وارد کنید
3. مطمئن شوید پنل در دسترس است

### خطای ایجاد کاربر

اگر امکان ایجاد کاربر روی پنل Hiddify وجود ندارد:
1. بررسی کنید که نسخه API پنل شما با endpoint های استفاده شده سازگار باشد
2. لاگ‌های پنل Hiddify را بررسی کنید
3. مجوزهای کاربر ادمین را بررسی کنید

### بررسی لاگ‌ها

برای دیدن جزئیات خطاها:
```bash
# مشاهده لاگ‌های ربات
tail -f logs/bot.log

# یا استفاده از systemd
journalctl -u meowvpnbot -f
```

---

## سوالات متداول

**س: آیا می‌توانم فقط از پنل Hiddify استفاده کنم؟**
ج: بله، می‌توانید تنها پنل‌های Hiddify اضافه کنید یا ترکیبی از هر دو.

**س: آیا پنل‌های قدیمی Marzban من کار می‌کنند؟**
ج: بله، پنل‌های موجود شما بدون هیچ مشکلی کار می‌کنند. مایگریشن به طور خودکار نوع آنها را به Marzban تنظیم می‌کند.

**س: آیا می‌توانم نوع یک پنل را تغییر دهم؟**
ج: خیر، بعد از ایجاد پنل نمی‌توانید نوع آن را تغییر دهید. باید پنل را حذف کرده و دوباره با نوع صحیح اضافه کنید.

**س: آیا لینک اشتراک ترکیبی با هر دو نوع پنل کار می‌کند؟**
ج: بله، ربات لینک‌های اشتراک از تمام پنل‌های فعال را ترکیب می‌کند، صرف نظر از نوع آنها.

---

## پشتیبانی

اگر مشکلی دارید:
1. ابتدا لاگ‌های ربات را بررسی کنید
2. مطمئن شوید مایگریشن دیتابیس اجرا شده است
3. تنظیمات پنل‌های خود را بررسی کنید
4. در صورت ادامه مشکل، یک issue در GitHub ایجاد کنید

---

## مثال کد

### استفاده از Factory

```python
from services.panel_api_factory import get_panel_api
from database.models.panel import Panel

# دریافت پنل از دیتابیس
panel = db.query(Panel).filter(Panel.id == panel_id).first()

# دریافت API مناسب (Marzban یا Hiddify)
api = get_panel_api(panel)

# استفاده از API
user_details = await api.get_user(username)
await api.renew_user(service)
```

### چک کردن نوع پنل

```python
from database.models.panel import PanelType

if panel.panel_type == PanelType.MARZBAN:
    print("این یک پنل Marzban است")
elif panel.panel_type == PanelType.HIDDIFY:
    print("این یک پنل Hiddify است")
```

---

## تاریخچه نسخه‌ها

### v2.0.0 (2025-10-19)
- ✨ افزودن پشتیبانی از Hiddify
- ✨ ایجاد Panel API Factory
- ✨ مایگریشن دیتابیس برای panel_type
- 🔧 بهبود مدیریت پنل‌ها
- 📝 بروزرسانی مستندات

---

تبریک می‌گوییم! ربات شما اکنون از پنل‌های Marzban و Hiddify پشتیبانی می‌کند! 🎉

